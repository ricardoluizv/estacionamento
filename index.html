<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="jquery.js"></script>
    <script src="jquery-collision.min.js"></script>
    <style type="text/css">

        .divCancela{
            float: left;
            margin-right:30px;
        }

        .img_cancela{
            width:18px;
            height:120px;
            display: block;

        }

        .img_cancela_barra{
            width:143px;
            height:14px;
            display: block;
            margin-bottom: 10px;
        }


        .itemBarraParada{
            float: left;
        }

        .img_car {
            width:95px;
            height:103px;
            transform: rotate(90deg);
            position: absolute;

        }



        .divItemCancela{
            float: left;
        }

        .divItemCancelaBarra{
            float: left;
            margin-top: 40px;
            width: 161px;


        }

        .itemCancelaBarra{

        }

        #areaEntrada{
            margin-top:10%;
        }

        .divItemCarro{
            position: fixed;

            z-index: -1;

            /*bottom: 10%;*/
        }



        
    </style>

    <script type="text/javascript">

        //Cronômetro
        var startValue = 1000; //Number of milliseconds
        var time = new Date(startValue);
        var interv;
        //fim cronômetro

        var cancelaEntrada = [0, 0, 0, 0,0,0]; //Inicializa as cancelas colocando como não ocupado
        var carroEntrada = [0, 1, 2, 3];

        //DADOS DAS POSIÇÕES DOS ELEMENTOS PARA ANIMAR
        var listCarPos = new Array();
        var listCancelaBarra = new Array();

        //FIM DADOS DAS POSIÇÕES DOS ELEMENTOS PARA ANIMAR



        //VALOR DE ENTRADA
        var quantidadeCarro = 0;
        var quantidadeEstacionado = 0;
        var quantidadeCarroCriado = 0;

        var quantidadeCarroSaindo = 0;
        var quantidadeCarroSaido = 0;

        var carroSel = -1;

        $(document).ready(function () {

            $('#btnStart').click(function () {
                Inicializa();
            });

        });



        function Inicializa() {

            IniciarCronometro();

            quantidadeCarro = parseInt($('#txtLimiteEstacionamento').val());

            $("#contador").text(quantidadeEstacionado);

            cancelaEntrada.forEach(AddCancela);
            cancelaEntrada.forEach(AddCancelaBarra);

            $('#grupoCancela'+(cancelaEntrada.length-1)).hide();



            $('#areaEntrada').append('<div style="clear: both;"></div>');


            var posLeft = 40;
            listCarPos[0] = posLeft;
            for (var i=1; i< cancelaEntrada.length; i++)
            {
                posLeft += 220;
                listCarPos[i] = posLeft;

            }


            if (quantidadeCarro > 0) {

                SorteiaProxCancela();

                /*
                setTimeout(function(){

                    alert('sada');
                    if (quantidadeCarroCriado >= quantidadeCarro) {
                        MoveCarroSaida(0);
                    }

                },2000);*/
                VerificaFimEntrada();


            }
        }
        

        function VerificaFimEntrada(){

            //alert(quantidadeCarroCriado);

            if (quantidadeEstacionado >= quantidadeCarro) {

                $('#tempoEntrada').text( fillZeroes(time.getMinutes()) + ":" + fillZeroes(time.getSeconds()));
                PararCronometro();

                $('#grupoCancela'+(cancelaEntrada.length-1)).show();

                VerificaFimSaida();
                SorteiaProxCancelaSaida();

                IniciarCronometro();

            }else{
                setTimeout(VerificaFimEntrada, 2000);
            }

        }

        function VerificaFimSaida(){

            //alert(quantidadeCarroCriado);

            if (quantidadeCarroSaido >= quantidadeCarro) {

                $('#tempoSaida').text( fillZeroes(time.getMinutes()) + ":" + fillZeroes(time.getSeconds()));
                PararCronometro();


                $('#grupoCancela'+(cancelaEntrada.length-1)).show();

            }else{
                setTimeout(VerificaFimSaida, 2000);
            }

        }

        function SorteiaProxCancela(){
            var idCancela = parseInt((Math.random() * 100)%5);

            if (cancelaEntrada[idCancela] == 0){
                cancelaEntrada[idCancela] = 1; //Coloca como ocupado

                if (quantidadeCarroCriado < quantidadeCarro) {
                    carroSel++;
                    var idCarro = carroSel;
                    AddCarro(idCancela, listCarPos[idCancela], idCarro);

                    ExecutaAnimacaoCarro(idCarro, idCancela);

                }
            }

            if (quantidadeCarroCriado < quantidadeCarro){
                setTimeout(SorteiaProxCancela, parseInt((Math.random() * 10000)%2000));
            }
        }

        function SorteiaProxCancelaSaida(){


            var idCancela = parseInt((Math.random() * 100)%6);

            if (cancelaEntrada[idCancela] == 0){
                cancelaEntrada[idCancela] = 1; //Coloca como ocupado

                if (quantidadeCarroSaindo < quantidadeCarro) {

                    var idCarro = carroSel;
                    //Move o carro para saída
                    MoveCarroSaida(idCarro,idCancela);
                    carroSel--;
                }
            }

            if (quantidadeCarroSaindo < quantidadeCarro){
                setTimeout(SorteiaProxCancelaSaida, parseInt((Math.random() * 10000)%2000));
            }
        }



        function ExecutaAnimacaoCarro(idCarro,idCancela){

            var limite = $(window).height();
            limite = (limite / 2);
            limite = limite - (limite * 0.4);

            $('#divItemCarro'+idCarro).animate({
                'top':limite
            },2000, null, function(){
                AbreCancela(idCancela, idCarro);
            });

        }

        function ContinuaAnimacaoCarro(idCancela, idCarro) {

            var carroHeight =  $('#carro'+idCarro);
            var distancia = carroHeight.outerHeight() * -1;

           //alert(carroHeight.outerHeight());
            $('#divItemCarro'+idCarro).animate({
                'top':distancia
            },2000, null, function(){

                FechaCancela(idCancela);
            });

        }

        function ContinuaAnimacaoCarroSaida(idCancela,idCarro){

            var distancia =  $(window).height();

            //alert(carroHeight.outerHeight());
            $('#divItemCarro'+idCarro).animate({
                'top':distancia
            },2000, null, function(){

                FechaCancelaSaida(idCancela);
            });

        }

        /***
         * Abre a cancela entrada
         * @param id indice da cancela
         * @param idCarro indice do carro
         * @constructor
         */
        function AbreCancela(id, idCarro) {

            //alert('teste');
            $('#cancelaBarra'+id).animate({
                'margin-left':'-30px'
            }, 2000,null, function () {

                ContinuaAnimacaoCarro(id,idCarro);
            });

            Rotacionar(-45, '#cancelaBarra'+id, 2000,0);
        }

        function AbreCancelaSaida(id, idCarro) {

            //alert('teste');
            $('#cancelaBarra'+id).animate({
                'margin-left':'-30px'
            }, 2000,null, function () {

                ContinuaAnimacaoCarroSaida(id,idCarro);
            });

            Rotacionar(-45, '#cancelaBarra'+id, 2000,0);
        }

        /***
         * Fecha cancela entrada
         * @param idCancela indice do carro
         * @constructor
         */
        function FechaCancela(idCancela) {



            $('#cancelaBarra'+idCancela).animate({
                'margin-left':'0px'
            }, 2000,null, function () {

                quantidadeEstacionado++;
                $("#contador").text(quantidadeEstacionado);

                cancelaEntrada[idCancela] = 0; //libera a cancela para o próximo carro

            });

            Rotacionar(0, '#cancelaBarra'+idCancela, 2000,-45);
        }
        
        function FechaCancelaSaida(idCancela) {

            $('#cancelaBarra'+idCancela).animate({
                'margin-left':'0px'
            }, 2000,null, function () {

                quantidadeCarroSaido++;
                $("#contadorSaida").text(quantidadeCarroSaido);

                cancelaEntrada[idCancela] = 0; //libera a cancela para o próximo carro

            });

            Rotacionar(0, '#cancelaBarra'+idCancela, 2000,-45);


        }

        function AddCancela(item, index) {

            $('#areaEntrada').append('' +
                '<div id="grupoCancela'+index+'" class="divCancela" >' +
                '<div class="divItemCancela" id="divItemCancela'+index+'">' +
                '   <img id="divImgCancela'+index+'" class="img_cancela" src="cancela.png" />' +
                '</div>' +
                '</div>');

        }

        function AddCancelaBarra(item, index) {
            $('#grupoCancela'+index).append('<div class="divItemCancelaBarra"><img id="cancelaBarra'+index+'" class="img_cancela_barra" src="cancela_barra.png" /></div>');

            //$('#areaEntrada').append('<div class="itemBarraParada"><img id="barra_parada\'+index+\'" class="barraParada" src="barra_parada.png" /></div>');

        }

        function AddCarro(index, left, idCarro){

            quantidadeCarroCriado++;
            $('body').append('<div id="divItemCarro'+idCarro+'" class="divItemCarro" style=" left: '+left+'px; bottom: 10%;" >' +
                '<img id="carro'+idCarro+'" class="img_car" src="car-top-red.png" />' +
                '</div>');

        }

        /*function AddCarroSaida(index, left, idCarro){

            quantidadeCarroCriado++;
            $('body').append('<div id="divItemCarro'+idCarro+'" class="divItemCarroSaida" style=" left: '+left+'px;" >' +
                '<img id="carro'+idCarro+'" class="img_car" src="car-top-red.png" />' +
                '</div>');

        }*/


        function Rotacionar(graus, elem, duracao, grausAtual){

            var $elem = $(elem);

            // we use a pseudo object for the animation
            // (starts from `0` to `angle`), you can name it as you want
            $({deg: grausAtual}).animate({deg: graus}, {
                duration: duracao,
                step: function(now) {
                    // in the step-callback (that is fired each step of the animation),
                    // you can use the `now` paramter which contains the current
                    // animation-position (`0` up to `angle`)
                    $elem.css({
                        transform: 'rotate(' + now + 'deg)',

                    });
                }
            });
        }


        /***
         * Pega o elemento que contém o carro
         * @param idCarro
         * @constructor
         */
        function MoveCarroSaida(idCarro, idCancela){

            quantidadeCarroSaindo++;

            Rotacionar(270, "#carro"+idCarro,0,0);

            var limite = $(window).height();
            /*limite = (limite / 2);
            limite = limite - (limite * 0.4);*/

            /*$('#divItemCarro'+idCarro).css("top", $('#divItemCarro'+idCarro).offset().top);
            $('#divItemCarro'+idCarro).css("left",listCarPos[0]);
            $('#divItemCarro'+idCarro).css("bottom", limite);*/

            $('#divItemCarro'+idCarro).css("left", listCarPos[idCancela]);


            /*var limite = $(window).height();
            limite = (limite / 2);
            limite = limite + (limite * 0.4);*/
            //var limite = $('#divItemCarro'+idCarro).offset().top;

            limite *= -1;
            //alert($('#divItemCarro'+idCarro).offset().top);


            $('#divItemCarro'+idCarro).animate({
                'top':103
            },2000, null, function(){
                //AbreCancela(idCancela, idCarro);
                AbreCancelaSaida(idCancela, idCarro)
            });

        }



        //Javascript


        function IniciarCronometro(){

            ResetCronometro();

            displayTime();
            //$(".start").on("click", function(){
                interv = setInterval(function(){
                    //time = new Date(time + 1000);
                    time.setSeconds(time.getSeconds() + 1);
                    /*if(time<=0){
                        clearInterval(interv);
                    }*/
                    displayTime();
                }, 1000);
            //});
            $(".stop").on("click", function(){

            });
            $(".pause").on("click", function(){
                clearInterval(interv);
            });
            $(".reset").on("click", function(){

            });
        }

        function ResetCronometro(){

            time = new Date(startValue);
            displayTime();

        }

        function PararCronometro(){
            clearInterval(interv);
            time = new Date(startValue);
            displayTime();
        }


        function displayTime(){
            $(".time").text(fillZeroes(time.getMinutes()) + ":" + fillZeroes(time.getSeconds()));
        }

        function fillZeroes(t){
            t = t+"";
            if(t.length==1)
                return "0" + t;
            else
                return t;
        }



    </script>

</head>
<body>
    <!--<img class="img_car" src="car-top-red.png" />

    <div id="carros"></div>-->
    <div style="float:right">
        <p>
            <input type="text" id="txtLimiteEstacionamento" value="1180" />
            <input type="button" id="btnStart" value="Iniciar" />
        </p>
        <p><h3 id="contador">0</h3> carros estacionados</p>
        <p><h3 id="contadorSaida">0</h3>carros saído do estacionamento</p>

        <p>Cronômetro: <h3 class="time"></h3></p>
        <p>Tempo para entrada veículos: <h3 id="tempoEntrada"></h3></p>
        <p>Tempo para saída veículos: <h3 id="tempoSaida"></h3></p>
    </div>


    <div id="areaEntrada"></div>


    <!--<div id="divItemCarro0" class="divItemCarro" style=""><img id="carro0" class="img_car" src="car-top-red.png"></div>-->


</body>
</html>